box: wercker/android
build:
  steps:
    - install-packages:
        packages: git openjdk-7-jdk openjdk-7-jre-headless
    - script:
        name: Show base information
        code: |
          gradle -v
          echo $ANDROID_HOME
          echo $ANDROID_SDK_VERSION
          echo $ANDROID_BUILD_TOOLS
          echo $ANDROID_UPDATE_FILTERS
    - android-sdk-update:
        filter: tools, platform-tools, build-tools-23.0.1, sysimg-23
    - setup-android-emulator:
        target: android-23
    - script:
        name: Run Gradle connectedCheck
        code: |
          gradle --project-cache-dir=$WERCKER_CACHE_DIR connectedCheck
    - script:
        name: Run Gradle Build
        code: |
          gradle assembleRelease
  after-steps:
    - script:
        name: Inspect build result
        code: |
          ls -a razorpay-android-sample-app/build/apk
          cp razorpay-android-sample-app/build/apk/*.apk $WERCKER_REPORT_ARTEFACTS_DIR
    - script:
        name: Sign APK with jarsigner
        code: |
          jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore ../KEYSTORE/razorpay-android-sample-app.jks -storepass $KEYSTORE_PASSWD -keypass $PRIVATE_KEY_PASSWD build/outputs/apk/sample-old-release-unsigned.apk razorpay-android-sample-app
    - script:
        name: zipalign
        code: |
          zipalign -v 4 checkout-app/build/outputs/apk/checkout-app-release-unsigned.apk final-release-signed-aligned.apk
    - slack-notifier:
        url: $SLACK_URL
        channel: tech_bots
        username: wercker
        icon_url: https://cdn.rawgit.com/wantedly/step-pretty-slack-notify/master/icons/$WERCKER_RESULT.jpg
